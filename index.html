<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POE 2 Trade Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- PropTypes is strictly required by the Recharts UMD bundle -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts (Must come after React and PropTypes) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            background-color: #f8fafc; 
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0;
            padding: 0;
        }
        .recharts-default-tooltip { 
            border-radius: 12px !important; 
            border: none !important; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Safe extraction of global variables
        const { useState, useMemo, useEffect } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
            BarChart, Bar, Cell 
        } = window.Recharts || {};

        // --- Helper Components ---

        const Icon = ({ name, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const StatCard = ({ title, value, unit, icon, trend, trendUp, subtitle }) => (
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-md transition-all">
                <div className="flex justify-between items-start mb-4">
                    <div className="p-2.5 bg-slate-50 rounded-2xl">
                        <Icon name={icon} className="w-6 h-6 text-indigo-600" />
                    </div>
                    {trend && (
                        <span className={`text-[10px] font-black px-2 py-1 rounded-full uppercase tracking-widest ${trendUp ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}`}>
                            {trend}
                        </span>
                    )}
                </div>
                <div className="space-y-1">
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">{title}</p>
                    <div className="flex items-baseline gap-1">
                        <span className="text-4xl font-black text-slate-900 tracking-tighter">{value}</span>
                        {unit && <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">{unit}</span>}
                    </div>
                    {subtitle && <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{subtitle}</p>}
                </div>
            </div>
        );

        const ChartCard = ({ title, children }) => (
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 className="text-sm font-black uppercase tracking-widest mb-8 text-slate-400">{title}</h3>
                {children}
            </div>
        );

        // --- Data Parsing ---

        const RAW_DATA = `
1/11/2026, 14:42:31,0af48314bb81af9bb14e403a564fb1e19ab2b28aa05bf292fd6fb6d6c095cfac,Onslaught Roar,650,355,Baloch#1592,listed 15 minutes ago,80% increased Critical Hit Chance for Spells,Sum: 50,Sum: 80,Sum: 225
1/11/2026, 14:42:31,8f1e9e25c2f0646c28c9e68a2400711d4b11094f65aee254281dbae445d61fc4,Miracle Spire,675,466,Rmarkey#6383,listed 20 hours ago,235% increased Spell Damage,Sum: 52,Sum: 95,Sum: 319
1/11/2026, 14:42:31,be6f47a18edd07991ef5f4cda028319129a53c8d819a8ff15271d547f1677aa4,Rune Mast,700,394,Shirocco22#1718,listed 3 hours ago,42% increased Cast Speed,Gain 38% of Damage as Extra Fire Damage,Sum: 92,Sum: 86,Sum: 216
1/11/2026, 14:42:31,4fa095286c0166001b6be089ed98fd1f570d6b25f2aa7d1c0dc2b274b8bf9524,Pandemonium Spell,800,399,relicym#2478,listed 9 hours ago,208% increased Spell Damage,Sum: 110,Sum: 81,Sum: 208
1/11/2026, 14:42:31,e59bde4e81cfcc4df2af3e8a0ead9477adf5ffe8cac49264a83261d8ff8e44ec,Apocalypse Spire,800,397,irosshh#8039,listed 4 hours ago,Gain 68% of Damage as Extra Cold Damage,Sum: 68,Sum: 81,Sum: 248
1/11/2026, 14:42:31,3ac4e154282dddb58672e8d59965be8bda2d8075515ee8e38f45bb0d98401456,Doom Pile,800,471,TheLastDance#8418,listed a day ago,235% increased Spell Damage,43% increased Cast Speed,Sum: 59,Sum: 89,Sum: 323
1/11/2026, 14:42:31,cd0c07c0e9792260ab34f008d800205432e1b38cf4b92f84183554242ed24450,Horror Weaver,800,409,XDerBos#5227,listed 7 hours ago,224% increased Spell Damage,Gain 63% of Damage as Extra Fire Damage,Sum: 105,Sum: 80,Sum: 224
1/11/2026, 14:42:31,9fceb73ad5ebd62632d682aa0fc957b441b761f34fe6ba54837a39a6d4a931e6,Kraken Pole,880,411,gentle666#3975,listed 11 hours ago,Gain 50% of Damage as Extra Cold Damage,Sum: 100,Sum: 106,Sum: 205
1/11/2026, 14:42:31,a2b2543cd8d9c37f190f140b1207d9b5cfbac29d591d371d1f3b1a75816aa9e6,Blood Roar,900,435,coven#2580,listed 6 hours ago,41% increased Cast Speed,Sum: 116,Sum: 87,Sum: 232
1/11/2026, 14:42:31,4600ecafd9d8992dedbcef7b4cba0776939e9a7dc6afd22bf06d397a00f20145,Soul Beam,950,451,yapobrilsya#4618,listed 14 hours ago,Gain 48% of Damage as Extra Fire Damage,Sum: 103,Sum: 95,Sum: 253
1/11/2026, 14:45:17,65d39785632981110d508ec8acb2e528f37942aacdf93c5c6581911c6af2e825,Victory Beam,1000,398,Soulbands#3664,listed 6 hours ago,49% increased Cast Speed,Sum: 116,Sum: 81,Sum: 201
1/11/2026, 14:52:32,d5a24775626affb65c91501a272f3f5419561a03eea0e19e0c6ae770f494f7b6,Doom Spell,300,436,lopkoTheGod#4261,listed 6 minutes ago,177% increased Spell Damage with Spells that cost Life,Sum: 59,Sum: 107,Sum: 270
1/11/2026, 15:00:16,4fa095286c0166001b6be089ed98fd1f570d6b25f2aa7d1c0dc2b274b8bf9524,Pandemonium Spell,680,399,relicym#2478,listed 4 minutes ago,208% increased Spell Damage,Sum: 110,Sum: 81,Sum: 208,PRICE DROP (Was 800)
1/11/2026, 15:15:22,0af48314bb81af9bb14e403a564fb1e19ab2b28aa05bf292fd6fb6d6c095cfac,Onslaught Roar,650,355,Baloch#1592,listed an hour ago,80% increased Critical Hit Chance for Spells,Sum: 50,Sum: 80,Sum: 225
`;

        const parseData = (csv) => {
            return csv.trim().split('\n').map((line) => {
                const parts = line.split(',');
                const price = parseInt(parts[4]);
                const score = parseInt(parts[5]);
                const efficiencyRatio = price > 0 ? parseFloat((score / price).toFixed(3)) : 0;
                
                // Helper to extract numeric value from strings like "Sum: 50"
                const getSumValue = (val) => val ? parseInt(val.replace(/[^\d]/g, '')) || 0 : 0;

                return {
                    id: parts[2],
                    timestamp: `${parts[0]} ${parts[1]}`,
                    name: parts[3],
                    price: price,
                    score: score,
                    efficiencyRatio: efficiencyRatio,
                    seller: parts[6],
                    age: parts[7],
                    mods: parts[8] || '',
                    sumJ: getSumValue(parts[9]), // Column J
                    sumK: getSumValue(parts[10]), // Column K
                    sumL: getSumValue(parts[11]), // Column L
                    isPriceDrop: line.includes('PRICE DROP'),
                };
            }).filter(item => item && item.price > 0);
        };

        // --- Main App Component ---

        const App = () => {
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('overview');
            const data = useMemo(() => parseData(RAW_DATA), []);

            const stats = useMemo(() => {
                const prices = data.map(d => d.price);
                const ratios = data.map(d => d.efficiencyRatio);
                return {
                    avgPrice: prices.length ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : 0,
                    totalListings: data.length,
                    peakEfficiency: ratios.length ? Math.max(...ratios) : 0,
                    priceDrops: data.filter(d => d.isPriceDrop).length
                };
            }, [data]);

            const filteredData = useMemo(() => {
                return data.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.seller.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.mods.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => b.efficiencyRatio - a.efficiencyRatio);
            }, [data, searchTerm]);

            const priceTrend = useMemo(() => {
                const groups = {};
                data.forEach(d => {
                    if (!groups[d.timestamp]) groups[d.timestamp] = { time: d.timestamp, avg: 0, count: 0 };
                    groups[d.timestamp].avg += d.price;
                    groups[d.timestamp].count += 1;
                });
                return Object.values(groups).map(g => ({
                    time: g.time.split(' ')[1],
                    avgPrice: Math.round(g.avg / g.count)
                }));
            }, [data]);

            const attributeAverages = useMemo(() => {
                if (data.length === 0) return [];
                const totals = data.reduce((acc, d) => ({
                    sumJ: acc.sumJ + d.sumJ,
                    sumK: acc.sumK + d.sumK,
                    sumL: acc.sumL + d.sumL
                }), { sumJ: 0, sumK: 0, sumL: 0 });

                return [
                    { name: 'Extra Damage', value: Math.round(totals.sumJ / data.length) },
                    { name: 'Crit Chance', value: Math.round(totals.sumK / data.length) },
                    { name: 'Spellpower', value: Math.round(totals.sumL / data.length) }
                ];
            }, [data]);

            const COLORS = ['#6366f1', '#8b5cf6', '#ec4899'];

            return (
                <div className="min-h-screen p-4 md:p-8 space-y-8">
                    <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 max-w-7xl mx-auto">
                        <div>
                            <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">POE 2 Trade Terminal</h1>
                            <p className="text-slate-500 font-medium mt-1">Focusing on high efficiency Score/Price ratios</p>
                        </div>
                        <div className="relative group">
                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors" />
                            <input 
                                type="text"
                                placeholder="Search items, mods, or sellers..."
                                className="pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-2xl w-full md:w-96 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </header>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
                        <StatCard title="Avg Market Price" value={stats.avgPrice} unit="Divine Orbs" icon="dollar-sign" trend="+4.2%" trendUp={true} />
                        <StatCard title="Total Listings" value={stats.totalListings} icon="package" />
                        <StatCard title="Peak Efficiency" value={stats.peakEfficiency} unit="Ratio" icon="zap" subtitle="Best Score/Price" />
                        <StatCard title="Price Alerts" value={stats.priceDrops} icon="activity" subtitle="Recent drops" />
                    </div>

                    <div className="max-w-7xl mx-auto space-y-6">
                        <div className="flex border-b border-slate-200 gap-8 overflow-x-auto">
                            <button onClick={() => setActiveTab('overview')} className={`pb-4 px-2 text-sm font-bold relative transition-colors ${activeTab === 'overview' ? 'text-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}>
                                Market Overview
                                {activeTab === 'overview' && <div className="absolute bottom-0 left-0 w-full h-1 bg-indigo-600 rounded-full" />}
                            </button>
                            <button onClick={() => setActiveTab('table')} className={`pb-4 px-2 text-sm font-bold relative transition-colors ${activeTab === 'table' ? 'text-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}>
                                Live Listings
                                {activeTab === 'table' && <div className="absolute bottom-0 left-0 w-full h-1 bg-indigo-600 rounded-full" />}
                            </button>
                        </div>

                        <main>
                            {activeTab === 'overview' && (
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <ChartCard title="Market Price Trend">
                                        {window.Recharts ? (
                                            <ResponsiveContainer width="100%" height={300}>
                                                <LineChart data={priceTrend}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                    <XAxis dataKey="time" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <Tooltip />
                                                    <Line type="monotone" dataKey="avgPrice" stroke="#6366f1" strokeWidth={4} dot={{ r: 6, fill: '#6366f1', strokeWidth: 2, stroke: '#fff' }} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        ) : <div className="p-8 text-center text-slate-400">Loading charts...</div>}
                                    </ChartCard>

                                    <ChartCard title="Key Attribute Averages">
                                        {window.Recharts ? (
                                            <ResponsiveContainer width="100%" height={300}>
                                                <BarChart data={attributeAverages}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                    <XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <Tooltip cursor={{ fill: '#f1f5f9' }} />
                                                    <Bar dataKey="value" radius={[8, 8, 0, 0]}>
                                                        {attributeAverages.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                        ))}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        ) : <div className="p-8 text-center text-slate-400">Loading charts...</div>}
                                    </ChartCard>
                                </div>
                            )}

                            {activeTab === 'table' && (
                                <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-slate-50/50 border-b border-slate-200 text-sm font-bold text-slate-600">
                                                    <th className="px-6 py-5">Item Details</th>
                                                    <th className="px-6 py-5">Price</th>
                                                    <th className="px-6 py-5">Score</th>
                                                    <th className="px-6 py-5 bg-indigo-50/30">Value for Money</th>
                                                    <th className="px-6 py-5">Seller</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredData.map((item, idx) => (
                                                    <tr key={idx} className="hover:bg-slate-50/80 transition-colors">
                                                        <td className="px-6 py-5">
                                                            <div className="font-bold text-slate-900">{item.name}</div>
                                                            <div className="text-xs text-slate-500 truncate max-w-sm mt-0.5">{item.mods}</div>
                                                            {item.isPriceDrop && (
                                                                <span className="inline-flex items-center mt-2 px-2 py-0.5 rounded-full text-[10px] font-black bg-red-100 text-red-600 uppercase tracking-wider">
                                                                    <Icon name="trending-down" className="w-3 h-3 mr-1" /> Price Drop
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-5 font-mono text-slate-700 font-bold">{item.price}c</td>
                                                        <td className="px-6 py-5 font-bold text-slate-700">{item.score}</td>
                                                        <td className="px-6 py-5 font-black text-indigo-600 bg-indigo-50/10">
                                                            <span className="px-3 py-1 bg-indigo-100/50 rounded-lg">{item.efficiencyRatio}</span>
                                                        </td>
                                                        <td className="px-6 py-5 text-sm text-slate-500 font-mono">{item.seller}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        // --- Render ---

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
