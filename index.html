<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POE 2 Trade Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- PropTypes is strictly required by the Recharts UMD bundle -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts (Must come after React and PropTypes) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            background-color: #f8fafc; 
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0;
            padding: 0;
        }
        .recharts-default-tooltip { 
            border-radius: 12px !important; 
            border: none !important; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
            BarChart, Bar, Cell 
        } = window.Recharts || {};

        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSfkCGBl5HJVSUe9Kn7m5sLfAeFa3wRwbsBMzou0AOBTsWqXuGAFvVXa7-q4w4of-UNT-obNzSfePwj/pub?output=csv`;

        // --- Helper Components ---

        const Icon = ({ name, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const StatCard = ({ title, value, unit, icon, subtitle }) => (
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hover:shadow-md transition-all">
                <div className="flex justify-between items-start mb-4">
                    <div className="p-2.5 bg-slate-50 rounded-2xl">
                        <Icon name={icon} className="w-6 h-6 text-indigo-600" />
                    </div>
                </div>
                <div className="space-y-1">
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">{title}</p>
                    <div className="flex items-baseline gap-1">
                        <span className="text-4xl font-black text-slate-900 tracking-tighter">{value}</span>
                        {unit && <span className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">{unit}</span>}
                    </div>
                    {subtitle && <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{subtitle}</p>}
                </div>
            </div>
        );

        const ChartCard = ({ title, children, isLoading }) => (
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 relative min-h-[300px]">
                <h3 className="text-sm font-black uppercase tracking-widest mb-8 text-slate-400">{title}</h3>
                {isLoading && (
                    <div className="absolute inset-0 bg-white/50 backdrop-blur-[2px] z-10 flex items-center justify-center rounded-3xl">
                        <Icon name="refresh-cw" className="w-8 h-8 text-indigo-600 animate-spin" />
                    </div>
                )}
                {children}
            </div>
        );

        // --- Robust CSV Parser ---
        const parseCSVLine = (text) => {
            const result = [];
            let cur = '';
            let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    result.push(cur.trim());
                    cur = '';
                } else {
                    cur += char;
                }
            }
            result.push(cur.trim());
            return result;
        };

        const parseData = (csv) => {
            if (!csv) return [];
            const lines = csv.trim().split('\n');
            
            // Skip header
            const dataLines = lines.slice(1);

            return dataLines.map((line) => {
                const parts = parseCSVLine(line);
                if (parts.length < 5) return null;

                // User Mapping:
                // Column A (parts[0]): Timestamp (HH:MM:SS or Date HH:MM:SS)
                // Column C (parts[2]): Item Name
                // Column D (parts[3]): Price
                // Column E (parts[4]): Value (Score)
                // Column F (parts[5]): Seller
                // Column H (parts[7]): Mods
                // Column J (parts[9]): Sum J
                // Column K (parts[10]): Sum K
                // Column L (parts[11]): Sum L

                const rawTimestamp = parts[0] || '';
                // Extract HH:MM. If Column A contains "Date Time", split by space first.
                const timeOnly = rawTimestamp.includes(' ') 
                    ? rawTimestamp.split(' ')[1].slice(0, 5) 
                    : rawTimestamp.slice(0, 5);

                const name = parts[2];
                const price = parseInt(parts[3]?.replace(/[^\d]/g, '')) || 0;
                const score = parseInt(parts[4]?.replace(/[^\d]/g, '')) || 0;
                const efficiencyRatio = price > 0 ? parseFloat((score / price).toFixed(3)) : 0;
                
                const getSumValue = (val) => val ? parseInt(val.replace(/[^\d]/g, '')) || 0 : 0;

                return {
                    timeDisplay: timeOnly,
                    timestamp: `${parts[0]} ${parts[1]}`,
                    name: name,
                    price: price,
                    score: score,
                    efficiencyRatio: efficiencyRatio,
                    seller: parts[5],
                    mods: parts[7] || '',
                    sumJ: getSumValue(parts[9]), 
                    sumK: getSumValue(parts[10]),
                    sumL: getSumValue(parts[11]),
                    isPriceDrop: line.includes('PRICE DROP'),
                };
            }).filter(item => item && item.price > 0 && item.name);
        };

        // --- Main App Component ---

        const App = () => {
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('overview');
            const [rawData, setRawData] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [lastUpdated, setLastUpdated] = useState('Never');
            const [error, setError] = useState(null);

            const data = useMemo(() => parseData(rawData), [rawData]);

            const stats = useMemo(() => {
                const prices = data.map(d => d.price);
                const ratios = data.map(d => d.efficiencyRatio);
                return {
                    avgPrice: prices.length ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : 0,
                    totalListings: data.length,
                    peakEfficiency: ratios.length ? Math.max(...ratios) : 0,
                    priceDrops: data.filter(d => d.isPriceDrop).length
                };
            }, [data]);

            const filteredData = useMemo(() => {
                return data.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.seller.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.mods.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => b.efficiencyRatio - a.efficiencyRatio);
            }, [data, searchTerm]);

            const priceTrend = useMemo(() => {
                const groups = {};
                data.forEach(d => {
                    const timeKey = d.timestamp.split(' ')[1] || '00:00:00';
                    if (!groups[timeKey]) groups[timeKey] = { time: timeKey, avg: 0, count: 0 };
                    groups[timeKey].avg += d.price;
                    groups[timeKey].count += 1;
                });
                return Object.values(groups).map(g => ({
                    time: g.time,
                    avgPrice: Math.round(g.avg / g.count)
                })).sort((a, b) => a.time.localeCompare(b.time));
            }, [data]);

            const attributeAverages = useMemo(() => {
                if (data.length === 0) return [];
                const totals = data.reduce((acc, d) => ({
                    sumJ: acc.sumJ + d.sumJ,
                    sumK: acc.sumK + d.sumK,
                    sumL: acc.sumL + d.sumL
                }), { sumJ: 0, sumK: 0, sumL: 0 });

                return [
                    { name: 'Extra Damage', value: Math.round(totals.sumJ / data.length) },
                    { name: 'Crit Chance', value: Math.round(totals.sumK / data.length) },
                    { name: 'Spellpower', value: Math.round(totals.sumL / data.length) }
                ];
            }, [data]);

            const handleRefresh = useCallback(async () => {
                setIsLoading(true);
                setError(null);
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error('Sync failed. Check spreadsheet publish status.');
                    const text = await response.text();
                    setRawData(text);
                    setLastUpdated(new Date().toLocaleTimeString());
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                handleRefresh();
            }, [handleRefresh]);

            const COLORS = ['#6366f1', '#8b5cf6', '#ec4899'];

            return (
                <div className="min-h-screen p-4 md:p-8 space-y-8">
                    <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 max-w-7xl mx-auto">
                        <div className="space-y-1">
                            <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">POE 2 Trade Terminal</h1>
                            <div className="flex items-center gap-3">
                                <p className="text-slate-500 font-medium text-sm">Active Market Sync</p>
                                <div className="h-4 w-px bg-slate-300"></div>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1">
                                    <Icon name="clock" className="w-3 h-3" /> Last Sync: {lastUpdated}
                                </p>
                            </div>
                        </div>
                        
                        <div className="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                            <button 
                                onClick={handleRefresh}
                                disabled={isLoading}
                                className="flex items-center justify-center gap-2 px-5 py-3 bg-white border border-slate-200 rounded-2xl text-slate-700 font-bold text-sm shadow-sm hover:bg-slate-50 active:scale-95 transition-all disabled:opacity-50 group w-full sm:w-auto"
                            >
                                <Icon name="refresh-cw" className={`w-4 h-4 text-indigo-600 ${isLoading ? 'animate-spin' : 'group-hover:rotate-180 transition-transform duration-500'}`} />
                                {isLoading ? 'Syncing...' : 'Sync Market Data'}
                            </button>
                            
                            <div className="relative group w-full sm:w-auto">
                                <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors" />
                                <input 
                                    type="text"
                                    placeholder="Search listings..."
                                    className="pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-2xl w-full md:w-80 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </div>
                    </header>

                    {error && (
                        <div className="max-w-7xl mx-auto bg-amber-50 border border-amber-200 text-amber-800 px-6 py-4 rounded-2xl flex items-center gap-3">
                            <Icon name="alert-triangle" className="w-5 h-5 text-amber-600" />
                            <p className="font-bold text-sm">{error}</p>
                        </div>
                    )}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
                        <StatCard title="Avg Market Price" value={stats.avgPrice} unit="Divine Orbs" icon="dollar-sign" />
                        <StatCard title="Total Listings" value={stats.totalListings} icon="package" />
                        <StatCard title="Peak Efficiency" value={stats.peakEfficiency} unit="Ratio" icon="zap" />
                        <StatCard title="Price Alerts" value={stats.priceDrops} icon="activity" />
                    </div>

                    <div className="max-w-7xl mx-auto space-y-6">
                        <div className="flex border-b border-slate-200 gap-8 overflow-x-auto">
                            <button onClick={() => setActiveTab('overview')} className={`pb-4 px-2 text-sm font-bold relative transition-colors ${activeTab === 'overview' ? 'text-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}>
                                Market Overview
                                {activeTab === 'overview' && <div className="absolute bottom-0 left-0 w-full h-1 bg-indigo-600 rounded-full" />}
                            </button>
                            <button onClick={() => setActiveTab('table')} className={`pb-4 px-2 text-sm font-bold relative transition-colors ${activeTab === 'table' ? 'text-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}>
                                Live Listings
                                {activeTab === 'table' && <div className="absolute bottom-0 left-0 w-full h-1 bg-indigo-600 rounded-full" />}
                            </button>
                        </div>

                        <main>
                            {activeTab === 'overview' && (
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <ChartCard title="Market Price Trend" isLoading={isLoading}>
                                        {window.Recharts && data.length > 0 ? (
                                            <ResponsiveContainer width="100%" height={300}>
                                                <LineChart data={priceTrend}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                    <XAxis dataKey="time" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <Tooltip />
                                                    <Line type="monotone" dataKey="avgPrice" stroke="#6366f1" strokeWidth={4} dot={{ r: 6, fill: '#6366f1', strokeWidth: 2, stroke: '#fff' }} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        ) : <div className="p-8 text-center text-slate-400 font-bold text-xs uppercase">No Data Synchronized</div>}
                                    </ChartCard>

                                    <ChartCard title="Key Attribute Averages" isLoading={isLoading}>
                                        {window.Recharts && data.length > 0 ? (
                                            <ResponsiveContainer width="100%" height={300}>
                                                <BarChart data={attributeAverages}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                    <XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                                                    <Tooltip cursor={{ fill: '#f1f5f9' }} />
                                                    <Bar dataKey="value" radius={[8, 8, 0, 0]}>
                                                        {attributeAverages.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                        ))}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        ) : <div className="p-8 text-center text-slate-400 font-bold text-xs uppercase">No Data Synchronized</div>}
                                    </ChartCard>
                                </div>
                            )}

                            {activeTab === 'table' && (
                                <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden relative min-h-[400px]">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-slate-50/50 border-b border-slate-200 text-sm font-bold text-slate-600">
                                                    <th className="px-6 py-5">Time</th>
                                                    <th className="px-6 py-5">Item Details</th>
                                                    <th className="px-6 py-5">Price</th>
                                                    <th className="px-6 py-5">Value</th>
                                                    <th className="px-6 py-5 bg-indigo-50/30 text-indigo-700">Value for Money</th>
                                                    <th className="px-6 py-5">Seller</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredData.map((item, idx) => (
                                                    <tr key={idx} className="hover:bg-slate-50/80 transition-colors">
                                                        <td className="px-6 py-5 font-mono text-xs text-slate-500">{item.timeDisplay}</td>
                                                        <td className="px-6 py-5">
                                                            <div className="font-bold text-slate-900">{item.name}</div>
                                                            <div className="text-xs text-slate-500 truncate max-w-sm mt-0.5">{item.mods}</div>
                                                            {item.isPriceDrop && (
                                                                <span className="inline-flex items-center mt-2 px-2 py-0.5 rounded-full text-[10px] font-black bg-red-100 text-red-600 uppercase tracking-wider">
                                                                    <Icon name="trending-down" className="w-3 h-3 mr-1" /> Price Drop
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-5 font-mono text-slate-700 font-bold">{item.price}c</td>
                                                        <td className="px-6 py-5 font-bold text-slate-700">{item.score}</td>
                                                        <td className="px-6 py-5 font-black text-indigo-600 bg-indigo-50/10">
                                                            <span className="px-3 py-1 bg-indigo-100/50 rounded-lg">{item.efficiencyRatio}</span>
                                                        </td>
                                                        <td className="px-6 py-5 text-sm text-slate-500 font-mono">{item.seller}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
